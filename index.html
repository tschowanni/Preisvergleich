<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Preisvergleich">
<meta name="theme-color" content="#0d0d0d">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="apple-touch-icon" href="icon-512.png">
<title>Preisvergleich CH / DE</title>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
:root {
  --bg:       #0d0d0d;
  --surface:  #181818;
  --card:     #1f1f1f;
  --border:   #2a2a2a;
  --accent:   #e8c547;
  --accent2:  #5b9cf6;
  --text:     #f0f0f0;
  --muted:    #777;
  --danger:   #e05555;
  --ch:       #d93025;
  --mono:     'DM Mono', monospace;
  --sans:     'Outfit', sans-serif;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€ HEADER â”€â”€ */
.app-header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: calc(14px + var(--safe-top)) 16px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.app-title {
  font-size: 1.3rem;
  font-weight: 800;
  letter-spacing: -0.5px;
}
.app-title span { color: var(--accent); }
.header-actions { display: flex; gap: 8px; }
.icon-btn {
  width: 40px; height: 40px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 1.1rem;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: background 0.15s;
}
.icon-btn:active { background: var(--border); }
.icon-btn.danger { color: var(--danger); border-color: rgba(224,85,85,0.3); }

/* â”€â”€ WECHSELKURS â”€â”€ */
.kurs-section {
  background: #131300;
  border-bottom: 1px solid #2a2700;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.kurs-label {
  font-family: var(--mono);
  font-size: 0.7rem;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  white-space: nowrap;
}
.kurs-field {
  display: flex;
  align-items: center;
  gap: 6px;
  background: #1e1d00;
  border: 1px solid #3d3b00;
  border-radius: 10px;
  padding: 6px 12px;
  flex: 1;
  min-width: 120px;
}
.kurs-field input {
  background: none;
  border: none;
  color: var(--text);
  font-family: var(--mono);
  font-size: 1.05rem;
  font-weight: 500;
  width: 100%;
  outline: none;
}
.kurs-unit { color: var(--muted); font-family: var(--mono); font-size: 0.8rem; }
.kurs-btn {
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 10px;
  padding: 8px 14px;
  font-family: var(--sans);
  font-size: 0.8rem;
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
}
.kurs-btn:active { opacity: 0.8; }
.sync-status {
  font-family: var(--mono);
  font-size: 0.68rem;
  color: var(--muted);
  width: 100%;
}

/* â”€â”€ TOOLBAR â”€â”€ */
.toolbar {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}
.product-count {
  font-family: var(--mono);
  font-size: 0.75rem;
  color: var(--muted);
}
.toolbar-btns { display: flex; gap: 8px; }
.add-btn {
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 12px;
  padding: 10px 18px;
  font-family: var(--sans);
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
}
.add-btn:active { opacity: 0.85; }

/* â”€â”€ PRODUCT LIST â”€â”€ */
.product-list {
  padding: 0 12px 100px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.product-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  overflow: hidden;
  transition: border-color 0.2s;
}
.product-card.expanded { border-color: var(--accent); }

/* â”€â”€ CARD HEADER ROW â”€â”€ */
.card-row {
  display: flex;
  align-items: center;
  padding: 14px 14px 14px 16px;
  cursor: pointer;
  gap: 10px;
  min-height: 76px;
}
.card-name {
  flex: 1;
  font-size: 1.1rem;
  font-weight: 700;
  line-height: 1.3;
}
.card-prices {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 3px;
  flex-shrink: 0;
}
.price-tag {
  font-family: var(--mono);
  font-size: 0.9rem;
  font-weight: 600;
  padding: 4px 10px;
  border-radius: 6px;
}
.price-chf { background: rgba(217,48,37,0.15); color: #f08080; }
.price-eur { background: rgba(91,156,246,0.15); color: #91b8f8; }
.chevron {
  color: var(--muted);
  font-size: 0.75rem;
  transition: transform 0.25s;
  flex-shrink: 0;
}
.product-card.expanded .chevron { transform: rotate(180deg); }

/* â”€â”€ EXPANDED DETAIL â”€â”€ */
.card-detail {
  display: none;
  border-top: 1px solid var(--border);
  padding: 16px;
  flex-direction: column;
  gap: 14px;
  animation: slideIn 0.2s ease;
}
.product-card.expanded .card-detail { display: flex; }
@keyframes slideIn {
  from { opacity: 0; transform: translateY(-6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* â”€â”€ FIELDS â”€â”€ */
.field {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.field label {
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--muted);
  font-family: var(--mono);
}
.field input {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 1rem;
  outline: none;
  width: 100%;
  -webkit-appearance: none;
}
.field input:focus { border-color: var(--accent); }

/* price row: two fields side by side */
.price-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* â”€â”€ CONVERTED â”€â”€ */
.converted-info {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.converted-info .lbl {
  font-family: var(--mono);
  font-size: 0.7rem;
  color: var(--muted);
}
.converted-info .val {
  font-family: var(--mono);
  font-size: 0.95rem;
  font-weight: 500;
  color: var(--accent2);
}

/* â”€â”€ FAZIT â”€â”€ */
.fazit {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.fazit-text {
  font-family: var(--mono);
  font-size: 0.82rem;
  line-height: 1.4;
}
.fazit-text strong { color: var(--accent); font-size: 1rem; }
.fazit-flags { display: flex; gap: 12px; align-items: center; }
.flag {
  width: 44px; height: 30px;
  border-radius: 6px;
  object-fit: cover;
  transition: opacity 0.3s, transform 0.3s;
  border: 1px solid rgba(255,255,255,0.1);
}
.flag.dim { opacity: 0.15; transform: scale(0.88); }

/* â”€â”€ IMAGE SECTION â”€â”€ */
.img-section {
  display: flex;
  gap: 10px;
  align-items: flex-start;
}
.img-preview {
  flex-shrink: 0;
  width: 100px;
  height: 80px;
  border-radius: 10px;
  background: var(--surface);
  border: 1px solid var(--border);
  overflow: hidden;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}
.img-preview img {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
}
.img-controls {
  display: flex;
  flex-direction: column;
  gap: 7px;
  flex: 1;
}
.img-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 9px;
  padding: 9px 12px;
  font-family: var(--sans);
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  text-align: center;
}
.img-btn:active { background: var(--border); }
.img-btn.del { color: var(--danger); border-color: rgba(224,85,85,0.25); }

/* â”€â”€ ACTION BUTTONS â”€â”€ */
.action-row {
  display: flex;
  gap: 8px;
}
.btn-save {
  flex: 1;
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 12px;
  padding: 14px;
  font-family: var(--sans);
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
}
.btn-save:active { opacity: 0.85; }
.btn-del {
  background: rgba(224,85,85,0.1);
  color: var(--danger);
  border: 1px solid rgba(224,85,85,0.25);
  border-radius: 12px;
  padding: 14px 18px;
  font-family: var(--sans);
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
}
.btn-del:active { background: rgba(224,85,85,0.2); }

/* â”€â”€ BOTTOM NAV (action sheet) â”€â”€ */
.bottom-sheet-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 200;
  align-items: flex-end;
}
.bottom-sheet-overlay.active { display: flex; }
.bottom-sheet {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  padding: 20px 20px calc(20px + var(--safe-bot));
  width: 100%;
  animation: sheetUp 0.25s cubic-bezier(.34,1.3,.64,1);
  display: flex;
  flex-direction: column;
  gap: 10px;
}
@keyframes sheetUp {
  from { transform: translateY(100%); }
  to   { transform: translateY(0); }
}
.sheet-title {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--muted);
  font-family: var(--mono);
  margin-bottom: 4px;
}
.sheet-btn {
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 12px;
  padding: 16px;
  font-family: var(--sans);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 12px;
}
.sheet-btn:active { background: var(--border); }
.sheet-btn.danger { color: var(--danger); }
.sheet-btn .ico { font-size: 1.3rem; width: 28px; text-align: center; }
.sheet-cancel {
  background: none;
  border: none;
  color: var(--muted);
  font-family: var(--sans);
  font-size: 0.95rem;
  padding: 12px;
  cursor: pointer;
  text-align: center;
  margin-top: 4px;
}

/* â”€â”€ MODAL DIALOGS â”€â”€ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 300;
  align-items: flex-end;
  padding: 0;
}
.modal-overlay.active { display: flex; }
.modal {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  padding: 24px 20px calc(24px + var(--safe-bot));
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 14px;
  animation: sheetUp 0.25s cubic-bezier(.34,1.3,.64,1);
  max-height: 90dvh;
  overflow-y: auto;
}
.modal h2 {
  font-size: 1.15rem;
  font-weight: 700;
}
.modal-actions {
  display: flex;
  gap: 8px;
  margin-top: 4px;
}
.btn-cancel {
  flex: 1;
  background: var(--card);
  border: 1px solid var(--border);
  color: var(--muted);
  border-radius: 12px;
  padding: 14px;
  font-family: var(--sans);
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
}

/* â”€â”€ LIGHTBOX â”€â”€ */
.lightbox {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 500;
  align-items: center;
  justify-content: center;
}
.lightbox.active { display: flex; }
.lightbox img {
  max-width: 95vw;
  max-height: 85dvh;
  object-fit: contain;
  border-radius: 12px;
}
.lightbox-close {
  position: fixed;
  top: calc(20px + var(--safe-top));
  right: 20px;
  color: #fff;
  font-size: 1.8rem;
  cursor: pointer;
  background: rgba(0,0,0,0.5);
  width: 44px; height: 44px;
  border-radius: 22px;
  display: flex; align-items: center; justify-content: center;
}

/* â”€â”€ CONFIRM â”€â”€ */
.confirm-modal {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  padding: 24px 20px calc(24px + var(--safe-bot));
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 14px;
  animation: sheetUp 0.25s cubic-bezier(.34,1.3,.64,1);
}
.confirm-modal p { color: var(--muted); font-size: 0.92rem; line-height: 1.5; }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: var(--muted);
}
.empty-state .ico { font-size: 3.5rem; margin-bottom: 14px; }
.empty-state p { font-size: 0.9rem; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed;
  bottom: calc(24px + var(--safe-bot));
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: rgba(30,30,30,0.96);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 11px 22px;
  border-radius: 999px;
  font-family: var(--mono);
  font-size: 0.82rem;
  z-index: 999;
  white-space: nowrap;
  transition: transform 0.3s cubic-bezier(.34,1.4,.64,1);
  pointer-events: none;
  backdrop-filter: blur(10px);
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
</style>
</head>
<body>

<!-- hidden flag sources -->
<div style="display:none">
  <img id="flagCH_src" src="ch.jpg" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 40 27%22><rect fill=%22%23e8343a%22 width=%2240%22 height=%2227%22/><rect fill=%22white%22 x=%2215%22 y=%225%22 width=%2210%22 height=%2217%22/><rect fill=%22white%22 x=%228%22 y=%2210%22 width=%2224%22 height=%227%22/></svg>'">
  <img id="flagDE_src" src="de.jpg" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 40 27%22><rect fill=%22%23111%22 width=%2240%22 height=%229%22/><rect fill=%22%23e02020%22 y=%229%22 width=%2240%22 height=%229%22/><rect fill=%22%23ffce00%22 y=%2218%22 width=%2240%22 height=%229%22/></svg>'">
</div>

<!-- hidden inputs -->
<input type="file" id="fileInput"   accept="image/*"              style="display:none" onchange="handleFileSelect(event)">
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(event)">
<input type="file" id="importInput" accept=".json"                style="display:none" onchange="importData(event)">

<!-- â”€â”€ HEADER â”€â”€ -->
<header class="app-header">
  <div class="app-title">Preis<span>vergleich</span></div>
  <div class="header-actions">
    <button class="icon-btn" onclick="openMenu()" title="MenÃ¼">â‹¯</button>
  </div>
</header>

<!-- â”€â”€ WECHSELKURS â”€â”€ -->
<div class="kurs-section">
  <span class="kurs-label">1 CHF =</span>
  <div class="kurs-field">
    <input type="number" id="kursInput" step="0.0001" value="0.9400" inputmode="decimal">
    <span class="kurs-unit">EUR</span>
  </div>
  <button class="kurs-btn" onclick="fetchKurs()">â†» Kurs</button>
  <div class="sync-status" id="syncStatus"></div>
  <div style="font-family:var(--mono);font-size:0.6rem;color:#444;width:100%;text-align:right;">v202602271457</div>
</div>

<!-- â”€â”€ TOOLBAR â”€â”€ -->
<div class="toolbar">
  <span class="product-count" id="productCount">0 Produkte</span>
  <button class="add-btn" onclick="openAddDialog()">ï¼‹ HinzufÃ¼gen</button>
</div>

<!-- â”€â”€ PRODUCT LIST â”€â”€ -->
<div class="product-list" id="productList"></div>
<div class="empty-state" id="emptyState" style="display:none">
  <div class="ico">ğŸ›’</div>
  <p>Noch keine Produkte.<br>Tippe auf + HinzufÃ¼gen.</p>
</div>

<!-- â”€â”€ MENU BOTTOM SHEET â”€â”€ -->
<div class="bottom-sheet-overlay" id="menuOverlay" onclick="closeMenu()">
  <div class="bottom-sheet" onclick="event.stopPropagation()">
    <div class="sheet-title">Optionen</div>
    <button class="sheet-btn" onclick="exportPDF(); closeMenu()">
      <span class="ico">ğŸ“„</span> PDF erstellen &amp; senden
    </button>
    <button class="sheet-btn" onclick="exportData(); closeMenu()">
      <span class="ico">â†“</span> Daten exportieren (JSON)
    </button>
    <button class="sheet-btn" onclick="closeMenu(); document.getElementById('importInput').click()">
      <span class="ico">â†‘</span> Daten importieren (JSON)
    </button>
    <button class="sheet-cancel" onclick="closeMenu()">Abbrechen</button>
  </div>
</div>

<!-- â”€â”€ ADD DIALOG â”€â”€ -->
<div class="modal-overlay" id="addOverlay">
  <div class="modal">
    <h2>Neues Produkt</h2>
    <div class="field">
      <label>Produktname</label>
      <input type="text" id="addName" placeholder="z.B. Barilla Pasta 500gr" autocomplete="off">
    </div>
    <div class="price-row">
      <div class="field">
        <label>Preis CHF ğŸ‡¨ğŸ‡­</label>
        <input type="number" id="addCHF" placeholder="0.00" step="0.01" inputmode="decimal">
      </div>
      <div class="field">
        <label>Preis EUR ğŸ‡©ğŸ‡ª</label>
        <input type="number" id="addEUR" placeholder="0.00" step="0.01" inputmode="decimal">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeAddDialog()">Abbrechen</button>
      <button class="btn-save" onclick="addProduct()">HinzufÃ¼gen</button>
    </div>
  </div>
</div>

<!-- â”€â”€ CONFIRM DELETE â”€â”€ -->
<div class="modal-overlay" id="confirmOverlay">
  <div class="confirm-modal">
    <h2>LÃ¶schen?</h2>
    <p id="confirmText"></p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeConfirm()">Abbrechen</button>
      <button class="btn-del" onclick="confirmDelete()">Ja, lÃ¶schen</button>
    </div>
  </div>
</div>

<!-- â”€â”€ LIGHTBOX â”€â”€ -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <div class="lightbox-close">âœ•</div>
  <img id="lightboxImg" src="" alt="">
</div>

<!-- â”€â”€ TOAST â”€â”€ -->
<div class="toast" id="toast"></div>

<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  KONFIGURATION â€“ HIER EINTRAGEN  â–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JSONBIN_API_KEY = 'HIER_DEINEN_API_KEY_EINTRAGEN';   // z.B. '$2a$10$abc123...'
const JSONBIN_BIN_ID  = 'HIER_DEINE_BIN_ID_EINTRAGEN';     // z.B. '64a3f2b1e1234567890'
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LAYER  â€“  JSONBin (online) + localStorage (offline-Cache)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_KEY = 'preisvergleich_v1';

function getDefaultProducts() {
  return [
    { id: uid(), name: 'OVO 500gr',             chf: 7.60,  eur: 4.99,  img: null },
    { id: uid(), name: 'Barilla Pasta 500gr',   chf: 2.10,  eur: 1.59,  img: null },
    { id: uid(), name: 'Milka Schokolade 100gr',chf: 1.69,  eur: 0.69,  img: null },
    { id: uid(), name: 'Persil 5L',             chf: 21.00, eur: 9.99,  img: null },
    { id: uid(), name: 'Pouletbrust pro Kg',    chf: 19.50, eur: 11.99, img: null },
    { id: uid(), name: 'Ravioli 500gr',         chf: 3.95,  eur: 1.29,  img: null },
    { id: uid(), name: 'Honig 500gr',           chf: 7.95,  eur: 5.49,  img: null },
    { id: uid(), name: 'Uncle Bens Reis 1Kg',   chf: 4.90,  eur: 3.69,  img: null },
    { id: uid(), name: 'Eier 6 gekocht',        chf: 3.60,  eur: 1.27,  img: null },
    { id: uid(), name: 'Bratfett',              chf: 4.95,  eur: 0.89,  img: null },
    { id: uid(), name: 'Barilla Sauce',         chf: 3.50,  eur: 2.99,  img: null },
    { id: uid(), name: 'Maggi Pulversauce',     chf: 2.35,  eur: 0.89,  img: null },
    { id: uid(), name: 'Thommy Sauce',          chf: 4.50,  eur: 1.29,  img: null },
    { id: uid(), name: 'Calcon XXL-Pack',       chf: 25.30, eur: 9.74,  img: null },
    { id: uid(), name: 'WeichspÃ¼ler',      chf: 9.00,  eur: 2.91,  img: null },
    { id: uid(), name: 'Finish KlarsphÃ¼ler',chf: 9.40, eur: 1.84,  img: null },
    { id: uid(), name: 'Palmolive',             chf: 4.00,  eur: 0.99,  img: null },
    { id: uid(), name: 'Dusch Das',             chf: 4.50,  eur: 1.79,  img: null },
    { id: uid(), name: 'Buttermilch',           chf: 2.20,  eur: 0.69,  img: null },
    { id: uid(), name: 'Nippon',                chf: 1.00,  eur: 1.29,  img: null },
  ];
}

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

// â”€â”€ Lokaler Cache (Fallback wenn offline) â”€â”€
function loadLocalDB() {
  try {
    const raw = localStorage.getItem(DB_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return null;
}
function saveLocalDB(data) {
  try {
    localStorage.setItem(DB_KEY, JSON.stringify(data));
  } catch(e) {
    // Inkognito oder Storage blockiert â€“ kein Problem, Daten bleiben im Speicher
    console.warn('localStorage nicht verfÃ¼gbar â€“ Daten nur im Arbeitsspeicher');
  }
}

// â”€â”€ JSONBin: Daten laden â”€â”€
async function loadFromCloud() {
  if (JSONBIN_API_KEY.startsWith('HIER') || JSONBIN_BIN_ID.startsWith('HIER')) {
    return null; // nicht konfiguriert
  }
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
      headers: { 'X-Master-Key': JSONBIN_API_KEY }
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    return json.record; // { products: [...] }
  } catch(e) {
    console.warn('Cloud-Laden fehlgeschlagen:', e.message);
    return null;
  }
}

// â”€â”€ JSONBin: Daten speichern â”€â”€
async function saveToCloud(data) {
  if (JSONBIN_API_KEY.startsWith('HIER') || JSONBIN_BIN_ID.startsWith('HIER')) {
    return; // nicht konfiguriert
  }
  try {
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': JSONBIN_API_KEY
      },
      body: JSON.stringify(data)
    });
  } catch(e) {
    console.warn('Cloud-Speichern fehlgeschlagen:', e.message);
    showToast('âš ï¸ Cloud-Sync fehlgeschlagen â€“ lokal gespeichert');
  }
}

// â”€â”€ Speichern: lokal + cloud â”€â”€
function saveDB(data) {
  saveLocalDB(data);
  saveToCloud(data); // async, lÃ¤uft im Hintergrund
}

// â”€â”€ Init: versuche zuerst Cloud, dann lokalen Cache â”€â”€
async function initDB() {
  // Lokale Daten laden â€“ falls nichts vorhanden, Standarddaten verwenden
  let local = loadLocalDB();
  if (!local || !local.products || local.products.length === 0) {
    // Frische IDs generieren fÃ¼r Standardprodukte
    local = { products: getDefaultProducts() };
    saveLocalDB(local); // schlÃ¤gt im Inkognito fehl â€“ macht nichts
  }
  db = local;
  renderAll();
  updateSyncStatus('');
  return db;
}

function updateSyncStatus(msg) {
  const el = document.getElementById('syncStatus');
  if (el) el.textContent = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = { products: [] }; // wird durch initDB() befÃ¼llt
let expandedId = null;
let kurs = parseFloat(localStorage.getItem('wechselkurs') || '0.9400');
let pendingDeleteId = null;
let activeImageId = null; // for which product we're picking image

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WECHSELKURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('kursInput').value = kurs.toFixed(4);
document.getElementById('kursInput').addEventListener('change', () => {
  kurs = parseFloat(document.getElementById('kursInput').value) || 0.94;
  localStorage.setItem('wechselkurs', kurs);
  renderAll();
});

async function fetchKurs() {
  const btn = document.querySelector('.kurs-fetch-btn');
  btn.textContent = 'â³ LÃ¤dt...';
  btn.disabled = true;
  try {
    // Using open exchange-rate API (no key needed for EUR/CHF)
    const res = await fetch('https://api.exchangerate-api.com/v4/latest/CHF');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    const eurRate = data.rates && data.rates.EUR;
    if (eurRate) {
      kurs = parseFloat(eurRate.toFixed(4));
      document.getElementById('kursInput').value = kurs.toFixed(4);
      localStorage.setItem('wechselkurs', kurs);
      const date = new Date().toLocaleDateString('de-CH');
      document.getElementById('kursInfo').textContent = `Aktualisiert: ${date}`;
      showToast('âœ“ Kurs aktualisiert: 1 CHF = ' + kurs.toFixed(4) + ' EUR');
      renderAll();
    }
  } catch(e) {
    // Fallback: try another free API
    try {
      const res2 = await fetch('https://open.er-api.com/v6/latest/CHF');
      const data2 = await res2.json();
      if (data2.rates && data2.rates.EUR) {
        kurs = parseFloat(data2.rates.EUR.toFixed(4));
        document.getElementById('kursInput').value = kurs.toFixed(4);
        localStorage.setItem('wechselkurs', kurs);
        document.getElementById('kursInfo').textContent = `Aktualisiert: ${new Date().toLocaleDateString('de-CH')}`;
        showToast('âœ“ Kurs aktualisiert: 1 CHF = ' + kurs.toFixed(4) + ' EUR');
        renderAll();
      }
    } catch(e2) {
      showToast('âš ï¸ Kurs konnte nicht geladen werden. Bitte manuell eingeben.');
    }
  }
  btn.textContent = 'â†» Aktueller Kurs';
  btn.disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatCHF(val) {
  return val.toLocaleString('de-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function getNoPhoto() {
  // Returns the src for no-photo image
  const img = document.getElementById('flagCH_src'); // placeholder, we handle separately
  return 'keinfoto.jpg';
}

function renderAll() {
  const list = document.getElementById('productList');
  const empty = document.getElementById('emptyState');
  const count = document.getElementById('productCount');

  count.textContent = db.products.length + ' Produkte';

  if (db.products.length === 0) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  list.innerHTML = '';
  db.products.forEach(p => {
    list.appendChild(renderCard(p));
  });
}

function renderCard(p) {
  const isExpanded = expandedId === p.id;
  const chfInEur = p.chf * kurs;
  const diff = Math.abs(chfInEur - p.eur);
  const chCheaper = chfInEur < p.eur;
  const imgSrc = p.img || 'keinfoto.jpg';
  const chFlagSrc = document.getElementById('flagCH_src').src;
  const deFlagSrc = document.getElementById('flagDE_src').src;

  const card = document.createElement('div');
  card.className = 'product-card' + (isExpanded ? ' expanded' : '');
  card.dataset.id = p.id;

  card.innerHTML = `
    <div class="card-row" onclick="toggleCard('${p.id}')">
      <div class="card-name">${escHtml(p.name)}</div>
      <div class="card-prices">
        <span class="price-tag price-chf">${formatCHF(p.chf)} CHF</span>
        <span class="price-tag price-eur">${formatCHF(p.eur)} EUR</span>
      </div>
      <span class="chevron">â–¼</span>
    </div>
    <div class="card-detail">
      <div class="field">
        <label>Produktname</label>
        <input type="text" id="name_${p.id}" value="${escHtml(p.name)}" autocomplete="off">
      </div>
      <div class="price-row">
        <div class="field">
          <label>Preis CHF ğŸ‡¨ğŸ‡­</label>
          <input type="number" id="chf_${p.id}" value="${p.chf}" step="0.01" inputmode="decimal" oninput="onPriceChange('${p.id}')">
        </div>
        <div class="field">
          <label>Preis EUR ğŸ‡©ğŸ‡ª</label>
          <input type="number" id="eur_${p.id}" value="${p.eur}" step="0.01" inputmode="decimal" oninput="onPriceChange('${p.id}')">
        </div>
      </div>
      <div class="converted-info">
        <span class="lbl">CHF-Preis umgerechnet in EUR</span>
        <span class="val" id="conv_${p.id}">${formatCHF(chfInEur)} EUR</span>
      </div>
      <div class="fazit">
        <div class="fazit-text" id="fazit_${p.id}">
          <strong>${formatCHF(diff)} EUR</strong><br>gÃ¼nstiger in
        </div>
        <div class="fazit-flags">
          <img class="flag ${chCheaper ? '' : 'dim'}" id="flagCH_${p.id}" src="${chFlagSrc}" alt="CH">
          <img class="flag ${chCheaper ? 'dim' : ''}" id="flagDE_${p.id}" src="${deFlagSrc}" alt="DE">
        </div>
      </div>
      <div class="img-section">
        <div class="img-preview" onclick="openLightbox('${p.id}')">
          <img id="img_${p.id}" src="${imgSrc}" alt="Bild" onerror="this.src='keinfoto.jpg'">
        </div>
        <div class="img-controls">
          <button class="img-btn" onclick="event.stopPropagation(); pickImage('${p.id}', false)">ğŸ–¼ Galerie</button>
          <button class="img-btn" onclick="event.stopPropagation(); pickImage('${p.id}', true)">ğŸ“· Kamera</button>
          <button class="img-btn del" onclick="event.stopPropagation(); deleteImage('${p.id}')">âœ• Bild lÃ¶schen</button>
        </div>
      </div>
      <div class="action-row">
        <button class="btn-save" onclick="saveProduct('${p.id}')">âœ“ Speichern</button>
        <button class="btn-del" onclick="askDelete('${p.id}', '${escHtml(p.name)}')">ğŸ—‘</button>
      </div>
    </div>
  `;
  return card;
}


function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleCard(id) {
  expandedId = (expandedId === id) ? null : id;
  renderAll();
  if (expandedId) {
    setTimeout(() => {
      const card = document.querySelector(`[data-id="${expandedId}"]`);
      if (card) card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 50);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE PRICE CALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onPriceChange(id) {
  const chfVal = parseFloat(document.getElementById('chf_' + id).value) || 0;
  const eurVal = parseFloat(document.getElementById('eur_' + id).value) || 0;
  const chfInEur = chfVal * kurs;
  const diff = Math.abs(chfInEur - eurVal);
  const chCheaper = chfInEur < eurVal;

  const convEl = document.getElementById('conv_' + id);
  const fazitEl = document.getElementById('fazit_' + id);
  const flagCHEl = document.getElementById('flagCH_' + id);
  const flagDEEl = document.getElementById('flagDE_' + id);

  if (convEl) convEl.textContent = formatCHF(chfInEur) + ' EUR';
  if (fazitEl) fazitEl.innerHTML = `<strong>${formatCHF(diff)} EUR</strong> gÃ¼nstiger in`;
  if (flagCHEl) flagCHEl.className = 'flag-img' + (chCheaper ? '' : ' dim');
  if (flagDEEl) flagDEEl.className = 'flag-img' + (chCheaper ? ' dim' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE / DELETE / ADD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveProduct(id) {
  const nameEl = document.getElementById('name_' + id);
  const chfEl  = document.getElementById('chf_' + id);
  const eurEl  = document.getElementById('eur_' + id);

  const newName = nameEl ? nameEl.value.trim() : '';
  const newCHF  = parseFloat(chfEl ? chfEl.value : 0) || 0;
  const newEUR  = parseFloat(eurEl ? eurEl.value : 0) || 0;

  if (!newName) { showToast('âš ï¸ Name darf nicht leer sein!'); return; }

  const idx = db.products.findIndex(p => p.id === id);
  if (idx === -1) return;
  db.products[idx].name = newName;
  db.products[idx].chf  = newCHF;
  db.products[idx].eur  = newEUR;
  saveDB(db);
  expandedId = null;
  renderAll();
  showToast('âœ“ Gespeichert');
}

function askDelete(id, name) {
  pendingDeleteId = id;
  document.getElementById('confirmText').textContent = `MÃ¶chtest du "${name}" wirklich lÃ¶schen?`;
  document.getElementById('confirmOverlay').classList.add('active');
}
function closeConfirm() {
  pendingDeleteId = null;
  document.getElementById('confirmOverlay').classList.remove('active');
}
function confirmDelete() {
  if (!pendingDeleteId) return;
  db.products = db.products.filter(p => p.id !== pendingDeleteId);
  saveDB(db);
  if (expandedId === pendingDeleteId) expandedId = null;
  pendingDeleteId = null;
  closeConfirm();
  renderAll();
  showToast('ğŸ—‘ Produkt gelÃ¶scht');
}

// â”€â”€ ADD DIALOG â”€â”€
function openAddDialog() {
  document.getElementById('addName').value = '';
  document.getElementById('addCHF').value = '';
  document.getElementById('addEUR').value = '';
  document.getElementById('addOverlay').classList.add('active');
  setTimeout(() => document.getElementById('addName').focus(), 100);
}
function closeAddDialog() {
  document.getElementById('addOverlay').classList.remove('active');
}
function addProduct() {
  const name = document.getElementById('addName').value.trim();
  const chf  = parseFloat(document.getElementById('addCHF').value) || 0;
  const eur  = parseFloat(document.getElementById('addEUR').value) || 0;
  if (!name || !chf || !eur) {
    showToast('âš ï¸ Alle Felder ausfÃ¼llen!'); return;
  }
  const prod = { id: uid(), name, chf, eur, img: null };
  db.products.push(prod);
  saveDB(db);
  closeAddDialog();
  expandedId = prod.id;
  renderAll();
  showToast('âœ“ Produkt hinzugefÃ¼gt');
}

// â”€â”€ ENTER key in add dialog â”€â”€
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeAddDialog();
    closeConfirm();
    closeLightbox();
  }
  if (e.key === 'Enter' && document.getElementById('addOverlay').classList.contains('active')) {
    addProduct();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickImage(id, useCamera) {
  activeImageId = id;
  const input = useCamera
    ? document.getElementById('cameraInput')
    : document.getElementById('fileInput');
  input.value = '';
  input.click();
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file || !activeImageId) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const fullData = e.target.result; // data:image/...;base64,...
    // Resize before storing to save space
    resizeImage(fullData, 600, 400, (resized) => {
      const idx = db.products.findIndex(p => p.id === activeImageId);
      if (idx === -1) return;
      db.products[idx].img = resized;
      saveDB(db);
      // Update image without full re-render
      const imgEl = document.getElementById('img_' + activeImageId);
      if (imgEl) imgEl.src = resized;
      showToast('âœ“ Bild gespeichert');
    });
  };
  reader.readAsDataURL(file);
}

function resizeImage(dataUrl, maxW, maxH, callback) {
  const img = new Image();
  img.onload = function() {
    let w = img.width, h = img.height;
    if (w > maxW || h > maxH) {
      const ratio = Math.min(maxW / w, maxH / h);
      w = Math.round(w * ratio);
      h = Math.round(h * ratio);
    }
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);
    callback(canvas.toDataURL('image/jpeg', 0.7));
  };
  img.src = dataUrl;
}

function deleteImage(id) {
  const idx = db.products.findIndex(p => p.id === id);
  if (idx === -1) return;
  db.products[idx].img = null;
  saveDB(db);
  const imgEl = document.getElementById('img_' + id);
  if (imgEl) { imgEl.src = 'keinfoto.jpg'; }
  showToast('âœ“ Bild entfernt');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(id) {
  const imgEl = document.getElementById('img_' + id);
  if (!imgEl) return;
  const src = imgEl.src;
  if (!src || src.endsWith('keinfoto.jpg')) return; // don't lightbox the dummy
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('active');
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const kursVal = parseFloat(document.getElementById('kursInput').value) || kurs;
  const date = new Date().toLocaleDateString('de-CH');
  const pageW = doc.internal.pageSize.getWidth();

  // â”€â”€ Header Hintergrund â”€â”€
  doc.setFillColor(15, 15, 15);
  doc.rect(0, 0, pageW, 28, 'F');

  // â”€â”€ Titel â”€â”€
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(20);
  doc.setTextColor(232, 197, 71); // accent gelb
  doc.text('Preisvergleich CH / DE', 14, 12);

  doc.setFontSize(9);
  doc.setTextColor(180, 180, 180);
  doc.text('Erstellt am: ' + date + '   |   Wechselkurs: 1 CHF = ' + kursVal.toFixed(4) + ' EUR', 14, 20);

  // â”€â”€ Flaggen-Legende â”€â”€
  doc.setFontSize(8);
  doc.setTextColor(140, 140, 140);
  doc.text('Flagge zeigt: wo das Produkt guenstiger ist', pageW - 14, 20, { align: 'right' });

  // â”€â”€ Tabellen-Daten aufbereiten â”€â”€
  const rows = db.products.map((p, i) => {
    const chfInEur = p.chf * kursVal;
    const diff = Math.abs(chfInEur - p.eur);
    const chCheaper = chfInEur < p.eur;
    const diffFormatted = diff.toFixed(2).replace('.', '.');
    const winner = chCheaper ? 'CH guenstiger' : 'DE guenstiger';
    const saving = diffFormatted + ' EUR';

    return [
      i + 1,
      p.name,
      p.chf.toFixed(2) + ' CHF',
      p.eur.toFixed(2) + ' EUR',
      chfInEur.toFixed(2) + ' EUR',
      saving,
      winner
    ];
  });

  // â”€â”€ AutoTable â”€â”€
  doc.autoTable({
    startY: 32,
    head: [[
      '#',
      'Produkt',
      'Preis CH\n(CHF)',
      'Preis DE\n(EUR)',
      'CH-Preis\nin EUR',
      'Differenz\n(EUR)',
      'Guenstiger'
    ]],
    body: rows,
    theme: 'grid',
    styles: {
      font: 'helvetica',
      fontSize: 8.5,
      cellPadding: { top: 3, right: 4, bottom: 3, left: 4 },
      textColor: [30, 30, 30],
      lineColor: [200, 200, 200],
      lineWidth: 0.2,
      overflow: 'linebreak',
    },
    headStyles: {
      fillColor: [35, 35, 35],
      textColor: [232, 197, 71],
      fontStyle: 'bold',
      fontSize: 8,
      halign: 'center',
    },
    columnStyles: {
      0: { halign: 'center', cellWidth: 8 },
      1: { cellWidth: 55 },
      2: { halign: 'right', cellWidth: 22 },
      3: { halign: 'right', cellWidth: 22 },
      4: { halign: 'right', cellWidth: 22 },
      5: { halign: 'right', cellWidth: 22, fontStyle: 'bold' },
      6: { halign: 'center', cellWidth: 28 },
    },
    alternateRowStyles: {
      fillColor: [248, 248, 248],
    },
    didParseCell: function(data) {
      // Farbe fÃ¼r "Guenstiger"-Spalte
      if (data.column.index === 6 && data.section === 'body') {
        if (data.cell.raw.includes('CH')) {
          data.cell.styles.textColor = [180, 30, 40];   // CH rot
          data.cell.styles.fontStyle = 'bold';
        } else {
          data.cell.styles.textColor = [20, 100, 180];  // DE blau
          data.cell.styles.fontStyle = 'bold';
        }
      }
      // Differenz-Spalte grÃ¼n einfÃ¤rben
      if (data.column.index === 5 && data.section === 'body') {
        data.cell.styles.textColor = [40, 150, 80];
        data.cell.styles.fontStyle = 'bold';
      }
    },
    margin: { left: 14, right: 14 },
  });

  // â”€â”€ Zusammenfassung â”€â”€
  const finalY = doc.lastAutoTable.finalY + 8;
  const total = db.products.length;
  const chWins = db.products.filter(p => (p.chf * kursVal) < p.eur).length;
  const deWins = total - chWins;
  const avgSaving = db.products.reduce((sum, p) => {
    return sum + Math.abs((p.chf * kursVal) - p.eur);
  }, 0) / (total || 1);

  doc.setFillColor(245, 245, 245);
  doc.roundedRect(14, finalY, pageW - 28, 22, 3, 3, 'F');
  doc.setDrawColor(200, 200, 200);
  doc.roundedRect(14, finalY, pageW - 28, 22, 3, 3, 'S');

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(8.5);
  doc.setTextColor(50, 50, 50);
  doc.text('Zusammenfassung:', 20, finalY + 7);

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(8);
  doc.setTextColor(180, 30, 40);
  doc.text('CH guenstiger: ' + chWins + ' Produkte', 20, finalY + 14);
  doc.setTextColor(20, 100, 180);
  doc.text('DE guenstiger: ' + deWins + ' Produkte', 70, finalY + 14);
  doc.setTextColor(40, 150, 80);
  doc.text('Ã˜ Ersparnis: ' + avgSaving.toFixed(2) + ' EUR pro Produkt', 120, finalY + 14);

  // â”€â”€ Footer â”€â”€
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(7.5);
    doc.setTextColor(160, 160, 160);
    doc.text('Preisvergleich CH/DE  â€“  Seite ' + i + ' von ' + pageCount, pageW / 2, 290, { align: 'center' });
  }

  // â”€â”€ Speichern â”€â”€
  const filename = 'Preisvergleich_' + date.replace(/\./g, '-') + '.pdf';
  doc.save(filename);
  showToast('âœ“ PDF erstellt: ' + filename);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MANUAL SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function manualSync() {
  if (JSONBIN_API_KEY.startsWith('HIER') || JSONBIN_BIN_ID.startsWith('HIER')) {
    showToast('âš ï¸ Bitte erst API-Key und Bin-ID eintragen!');
    return;
  }
  updateSyncStatus('â³ Synchronisiere...');
  const cloud = await loadFromCloud();
  if (cloud && cloud.products) {
    if (cloud.products.length >= db.products.length) {
      db = cloud;
      saveLocalDB(db);
      renderAll();
      showToast('â˜ï¸ Cloud-Daten geladen (' + db.products.length + ' Produkte)');
    } else {
      // Lokale Daten sind neuer â€“ hochladen
      await saveToCloud(db);
      showToast('â˜ï¸ Lokale Daten in Cloud gespeichert');
    }
    updateSyncStatus('â˜ï¸ Synchronisiert');
  } else {
    showToast('âš ï¸ Sync fehlgeschlagen');
    updateSyncStatus('âš ï¸ Sync-Fehler');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
  const json = JSON.stringify(db, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = 'preisvergleich_' + date + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('âœ“ Daten exportiert');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const parsed = JSON.parse(e.target.result);
      if (!parsed.products || !Array.isArray(parsed.products)) {
        showToast('âš ï¸ UngÃ¼ltige Datei â€“ kein gÃ¼ltiges Format');
        return;
      }
      // Ask confirmation if there are already products
      if (db.products.length > 0) {
        if (!confirm('Achtung: Alle aktuellen Daten werden mit den importierten Daten Ã¼berschrieben. Fortfahren?')) {
          event.target.value = '';
          return;
        }
      }
      db = parsed;
      saveDB(db);
      expandedId = null;
      renderAll();
      showToast('âœ“ ' + db.products.length + ' Produkte importiert');
    } catch(err) {
      showToast('âš ï¸ Fehler beim Lesen der Datei');
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initDB(); // async â€“ lÃ¤dt Cloud-Daten und rendert

// â”€â”€ MENU â”€â”€
function openMenu()  { document.getElementById('menuOverlay').classList.add('active'); }
function closeMenu() { document.getElementById('menuOverlay').classList.remove('active'); }
</script>
</body>
</html>