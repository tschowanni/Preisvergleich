<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preisvergleich CH / DE</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface2: #232323;
    --border: #2e2e2e;
    --accent: #e8c547;
    --accent2: #5b9cf6;
    --text: #f0f0f0;
    --muted: #888;
    --danger: #e05555;
    --success: #55c96a;
    --ch-red: #e8343a;
    --de-gold: #e8c547;
    --radius: 12px;
    --mono: 'DM Mono', 'Courier New', monospace;
    --sans: 'Syne', 'Trebuchet MS', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    position: sticky;
    top: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .header-title {
    font-size: 1.25rem;
    font-weight: 800;
    letter-spacing: -0.5px;
    flex: 1;
  }
  .header-title span { color: var(--accent); }

  /* â”€â”€ WECHSELKURS BAR â”€â”€ */
  .kurs-bar {
    background: #1e1e00;
    border-bottom: 1px solid #3a3800;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .kurs-label {
    font-family: var(--mono);
    font-size: 0.78rem;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }
  .kurs-input-wrap {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #2a2800;
    border: 1px solid #504e00;
    border-radius: 8px;
    padding: 4px 10px;
  }
  .kurs-input-wrap input {
    background: none;
    border: none;
    color: var(--text);
    font-family: var(--mono);
    font-size: 1rem;
    font-weight: 500;
    width: 80px;
    outline: none;
  }
  .kurs-unit { color: var(--muted); font-family: var(--mono); font-size: 0.85rem; }
  .kurs-fetch-btn {
    font-family: var(--sans);
    font-size: 0.75rem;
    font-weight: 600;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 6px;
    padding: 5px 12px;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .kurs-fetch-btn:hover { opacity: 0.85; }
  .kurs-info { font-family: var(--mono); font-size: 0.72rem; color: var(--muted); margin-left: auto; }

  /* â”€â”€ MAIN â”€â”€ */
  main { padding: 16px 20px; max-width: 900px; margin: 0 auto; }

  /* â”€â”€ TOOLBAR â”€â”€ */
  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 12px;
  }
  .toolbar-count {
    font-family: var(--mono);
    font-size: 0.8rem;
    color: var(--muted);
  }
  .btn-add {
    display: flex;
    align-items: center;
    gap: 6px;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: var(--radius);
    padding: 9px 18px;
    font-family: var(--sans);
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.1s, opacity 0.15s;
  }
  .btn-add:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-io {
    display: flex;
    align-items: center;
    gap: 5px;
    background: var(--surface2);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 9px 14px;
    font-family: var(--sans);
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    transition: border-color 0.15s;
  }
  .btn-io:hover { border-color: var(--accent2); color: var(--accent2); }

  /* â”€â”€ PRODUCT LIST â”€â”€ */
  .product-list { display: flex; flex-direction: column; gap: 8px; }

  .product-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .product-card.expanded { border-color: var(--accent); }

  .product-row {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    cursor: pointer;
    gap: 12px;
    user-select: none;
  }
  .product-name {
    flex: 1;
    font-weight: 600;
    font-size: 0.95rem;
  }
  .price-badges { display: flex; gap: 8px; align-items: center; }
  .badge {
    font-family: var(--mono);
    font-size: 0.78rem;
    padding: 3px 8px;
    border-radius: 6px;
    font-weight: 500;
  }
  .badge-chf { background: rgba(232,52,58,0.15); color: #e8a0a2; border: 1px solid rgba(232,52,58,0.3); }
  .badge-eur { background: rgba(91,156,246,0.15); color: #91b8f8; border: 1px solid rgba(91,156,246,0.3); }
  .chevron {
    color: var(--muted);
    font-size: 0.8rem;
    transition: transform 0.25s;
  }
  .product-card.expanded .chevron { transform: rotate(180deg); }

  /* â”€â”€ EXPANDED DETAIL â”€â”€ */
  .product-detail {
    display: none;
    padding: 0 16px 16px;
    border-top: 1px solid var(--border);
    animation: slideDown 0.2s ease;
  }
  .product-card.expanded .product-detail { display: block; }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .detail-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 14px;
  }
  @media (max-width: 560px) { .detail-grid { grid-template-columns: 1fr; } }

  .detail-left { display: flex; flex-direction: column; gap: 10px; }
  .detail-right {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .field-group label {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    display: block;
    margin-bottom: 4px;
    font-family: var(--mono);
  }
  .field-group input[type="text"],
  .field-group input[type="number"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.95rem;
    outline: none;
    transition: border-color 0.15s;
  }
  .field-group input:focus { border-color: var(--accent); }

  /* Converted price display */
  .converted-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 2px;
  }
  .converted-label {
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--muted);
  }
  .converted-value {
    font-family: var(--mono);
    font-size: 0.88rem;
    color: var(--accent2);
    font-weight: 500;
  }

  /* Fazit */
  .fazit-box {
    margin-top: 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .fazit-text {
    font-family: var(--mono);
    font-size: 0.85rem;
    color: var(--text);
  }
  .fazit-text strong { color: var(--accent); }
  .fazit-flags { display: flex; gap: 10px; align-items: center; }
  .flag-img {
    width: 40px;
    height: 27px;
    object-fit: cover;
    border-radius: 4px;
    transition: opacity 0.3s, transform 0.3s;
  }
  .flag-img.dim { opacity: 0.2; transform: scale(0.9); }

  /* Product image */
  .product-image-wrap {
    width: 100%;
    aspect-ratio: 4/3;
    max-height: 180px;
    border-radius: 10px;
    overflow: hidden;
    background: var(--surface2);
    border: 1px solid var(--border);
    cursor: pointer;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .product-image-wrap img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    display: block;
  }
  .img-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    font-size: 1.5rem;
  }
  .product-image-wrap:hover .img-overlay { opacity: 1; }

  .img-buttons { display: flex; gap: 6px; width: 100%; }
  .btn-img {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 8px;
    padding: 7px 6px;
    font-size: 0.72rem;
    font-family: var(--sans);
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    transition: border-color 0.15s;
  }
  .btn-img:hover { border-color: var(--accent2); }
  .btn-img-del { color: var(--danger); }
  .btn-img-del:hover { border-color: var(--danger); }

  /* Action buttons */
  .action-row {
    display: flex;
    gap: 8px;
    margin-top: 14px;
  }
  .btn-save {
    flex: 1;
    background: var(--accent);
    color: #000;
    border: none;
    border-radius: 8px;
    padding: 9px;
    font-family: var(--sans);
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .btn-save:hover { opacity: 0.88; }
  .btn-delete {
    background: rgba(224,85,85,0.12);
    color: var(--danger);
    border: 1px solid rgba(224,85,85,0.3);
    border-radius: 8px;
    padding: 9px 16px;
    font-family: var(--sans);
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.15s;
  }
  .btn-delete:hover { background: rgba(224,85,85,0.22); }

  /* â”€â”€ HIDDEN FILE INPUT â”€â”€ */
  #fileInput { display: none; }

  /* â”€â”€ LIGHTBOX â”€â”€ */
  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 999;
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
  }
  .lightbox.active { display: flex; }
  .lightbox img {
    max-width: 92vw;
    max-height: 88vh;
    border-radius: 12px;
    object-fit: contain;
    box-shadow: 0 0 60px rgba(0,0,0,0.8);
  }
  .lightbox-close {
    position: absolute;
    top: 20px; right: 24px;
    color: #fff;
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
  }

  /* â”€â”€ ADD DIALOG â”€â”€ */
  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 200;
    align-items: center;
    justify-content: center;
  }
  .overlay.active { display: flex; }
  .dialog {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    width: min(480px, 95vw);
    display: flex;
    flex-direction: column;
    gap: 14px;
    animation: popIn 0.2s ease;
  }
  @keyframes popIn {
    from { opacity: 0; transform: scale(0.95) translateY(10px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }
  .dialog h2 {
    font-size: 1.1rem;
    font-weight: 700;
  }
  .dialog-buttons { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; }
  .btn-cancel {
    background: var(--surface2);
    color: var(--muted);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 9px 18px;
    font-family: var(--sans);
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
  }

  /* â”€â”€ CONFIRM DIALOG â”€â”€ */
  .confirm-dialog {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    width: min(380px, 95vw);
    display: flex;
    flex-direction: column;
    gap: 16px;
    animation: popIn 0.2s ease;
  }
  .confirm-dialog p { color: var(--muted); font-size: 0.9rem; line-height: 1.5; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 20px;
    border-radius: 999px;
    font-family: var(--mono);
    font-size: 0.82rem;
    z-index: 9999;
    transition: transform 0.3s cubic-bezier(.34,1.56,.64,1);
    pointer-events: none;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
  .empty-state p { font-size: 0.9rem; }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<!-- â”€â”€ HEADER â”€â”€ -->
<header>
  <div class="header-title">Preis<span>vergleich</span> ğŸ‡¨ğŸ‡­ ğŸ‡©ğŸ‡ª</div>
</header>

<!-- â”€â”€ WECHSELKURS BAR â”€â”€ -->
<div class="kurs-bar">
  <span class="kurs-label">1 CHF =</span>
  <div class="kurs-input-wrap">
    <input type="number" id="kursInput" step="0.0001" value="0.9400">
    <span class="kurs-unit">EUR</span>
  </div>
  <button class="kurs-fetch-btn" onclick="fetchKurs()">â†» Aktueller Kurs</button>
  <span class="kurs-info" id="kursInfo">Bitte Kurs abrufen oder manuell eingeben</span>
  <button class="kurs-fetch-btn" onclick="manualSync()" style="background:var(--accent2);margin-left:4px;" title="Manuell mit Cloud synchronisieren">&#9729; Sync</button>
  <span class="kurs-info" id="syncStatus" style="margin-left:8px;color:#888;">&#8203;</span>
</div>

<!-- â”€â”€ MAIN â”€â”€ -->
<main>
  <div class="toolbar">
    <span class="toolbar-count" id="productCount">0 Produkte</span>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button class="btn-io" onclick="exportPDF()" title="PDF erstellen" style="border-color:#c0392b;color:#e05555;">&#128196; PDF</button>
      <button class="btn-io" onclick="exportData()" title="Daten exportieren">&#8659; Export</button>
      <button class="btn-io" onclick="document.getElementById('importInput').click()" title="Daten importieren">>&#8657; Import JSON</button>#8657; Import</button>
      <input type="file" id="importInput" accept=".json" style="display:none" onchange="importData(event)">
      <button class="btn-add" onclick="openAddDialog()">&#65291; Produkt hinzuf&uuml;gen</button>
    </div>
  </div>
  <div class="product-list" id="productList"></div>
  <div class="empty-state" id="emptyState" style="display:none">
    <div class="icon">ğŸ›’</div>
    <p>Noch keine Produkte. FÃ¼ge das erste hinzu!</p>
  </div>
</main>

<!-- â”€â”€ LIGHTBOX â”€â”€ -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close" onclick="closeLightbox()">âœ•</span>
  <img id="lightboxImg" src="" alt="">
</div>

<!-- â”€â”€ ADD DIALOG â”€â”€ -->
<div class="overlay" id="addOverlay">
  <div class="dialog">
    <h2>Neues Produkt</h2>
    <div class="field-group">
      <label>Produktname</label>
      <input type="text" id="addName" placeholder="z.B. Barilla Pasta 500gr">
    </div>
    <div class="field-group">
      <label>Preis CHF (Schweiz)</label>
      <input type="number" id="addCHF" placeholder="0.00" step="0.01">
    </div>
    <div class="field-group">
      <label>Preis EUR (Deutschland)</label>
      <input type="number" id="addEUR" placeholder="0.00" step="0.01">
    </div>
    <div class="dialog-buttons">
      <button class="btn-cancel" onclick="closeAddDialog()">Abbrechen</button>
      <button class="btn-save" style="flex:none;padding:9px 24px" onclick="addProduct()">HinzufÃ¼gen</button>
    </div>
  </div>
</div>

<!-- â”€â”€ CONFIRM DIALOG â”€â”€ -->
<div class="overlay" id="confirmOverlay">
  <div class="confirm-dialog">
    <h2>LÃ¶schen bestÃ¤tigen</h2>
    <p id="confirmText"></p>
    <div class="dialog-buttons">
      <button class="btn-cancel" onclick="closeConfirm()">Abbrechen</button>
      <button class="btn-delete" onclick="confirmDelete()">Ja, lÃ¶schen</button>
    </div>
  </div>
</div>

<!-- â”€â”€ HIDDEN FILE INPUT â”€â”€ -->
<input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
<input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(event)">

<!-- â”€â”€ TOAST â”€â”€ -->
<div class="toast" id="toast"></div>

<!-- â”€â”€ FLAG IMAGES (embedded as data URIs) â”€â”€ -->
<!-- We use actual image files if available, otherwise SVG flags -->
<div style="display:none">
  <img id="flagCH_src" src="ch.jpg" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 40 27%22><rect fill=%22%23e8343a%22 width=%2240%22 height=%2227%22/><rect fill=%22white%22 x=%2215%22 y=%225%22 width=%2210%22 height=%2217%22/><rect fill=%22white%22 x=%228%22 y=%2210%22 width=%2224%22 height=%227%22/></svg>'">
  <img id="flagDE_src" src="de.jpg" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 40 27%22><rect fill=%22%23000%22 width=%2240%22 height=%229%22/><rect fill=%22%23e02020%22 y=%229%22 width=%2240%22 height=%229%22/><rect fill=%22%23ffce00%22 y=%2218%22 width=%2240%22 height=%229%22/></svg>'">
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–ˆâ–ˆ  KONFIGURATION â€“ HIER EINTRAGEN  â–ˆâ–ˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const JSONBIN_API_KEY = 'HIER_DEINEN_API_KEY_EINTRAGEN';   // z.B. '$2a$10$abc123...'
const JSONBIN_BIN_ID  = 'HIER_DEINE_BIN_ID_EINTRAGEN';     // z.B. '64a3f2b1e1234567890'
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LAYER  â€“  JSONBin (online) + localStorage (offline-Cache)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_KEY = 'preisvergleich_v1';

function getDefaultProducts() {
  return [
    { id: uid(), name: 'OVO 500gr',             chf: 7.60,  eur: 4.99,  img: null },
    { id: uid(), name: 'Barilla Pasta 500gr',   chf: 2.10,  eur: 1.59,  img: null },
    { id: uid(), name: 'Milka Schokolade 100gr',chf: 1.69,  eur: 0.69,  img: null },
    { id: uid(), name: 'Persil 5L',             chf: 21.00, eur: 9.99,  img: null },
    { id: uid(), name: 'Pouletbrust pro Kg',    chf: 19.50, eur: 11.99, img: null },
    { id: uid(), name: 'Ravioli 500gr',         chf: 3.95,  eur: 1.29,  img: null },
    { id: uid(), name: 'Honig 500gr',           chf: 7.95,  eur: 5.49,  img: null },
    { id: uid(), name: 'Uncle Bens Reis 1Kg',   chf: 4.90,  eur: 3.69,  img: null },
    { id: uid(), name: 'Eier 6 gekocht',        chf: 3.60,  eur: 1.27,  img: null },
    { id: uid(), name: 'Bratfett',              chf: 4.95,  eur: 0.89,  img: null },
    { id: uid(), name: 'Barilla Sauce',         chf: 3.50,  eur: 2.99,  img: null },
    { id: uid(), name: 'Maggi Pulversauce',     chf: 2.35,  eur: 0.89,  img: null },
    { id: uid(), name: 'Thommy Sauce',          chf: 4.50,  eur: 1.29,  img: null },
    { id: uid(), name: 'Calcon XXL-Pack',       chf: 25.30, eur: 9.74,  img: null },
    { id: uid(), name: 'WeichspÃ¼ler',      chf: 9.00,  eur: 2.91,  img: null },
    { id: uid(), name: 'Finish KlarsphÃ¼ler',chf: 9.40, eur: 1.84,  img: null },
    { id: uid(), name: 'Palmolive',             chf: 4.00,  eur: 0.99,  img: null },
    { id: uid(), name: 'Dusch Das',             chf: 4.50,  eur: 1.79,  img: null },
    { id: uid(), name: 'Buttermilch',           chf: 2.20,  eur: 0.69,  img: null },
    { id: uid(), name: 'Nippon',                chf: 1.00,  eur: 1.29,  img: null },
  ];
}

function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

// â”€â”€ Lokaler Cache (Fallback wenn offline) â”€â”€
function loadLocalDB() {
  try {
    const raw = localStorage.getItem(DB_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return null;
}
function saveLocalDB(data) {
  try {
    localStorage.setItem(DB_KEY, JSON.stringify(data));
  } catch(e) {
    // Inkognito oder Storage blockiert â€“ kein Problem, Daten bleiben im Speicher
    console.warn('localStorage nicht verfÃ¼gbar â€“ Daten nur im Arbeitsspeicher');
  }
}

// â”€â”€ JSONBin: Daten laden â”€â”€
async function loadFromCloud() {
  if (JSONBIN_API_KEY.startsWith('HIER') || JSONBIN_BIN_ID.startsWith('HIER')) {
    return null; // nicht konfiguriert
  }
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
      headers: { 'X-Master-Key': JSONBIN_API_KEY }
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    return json.record; // { products: [...] }
  } catch(e) {
    console.warn('Cloud-Laden fehlgeschlagen:', e.message);
    return null;
  }
}

// â”€â”€ JSONBin: Daten speichern â”€â”€
async function saveToCloud(data) {
  if (JSONBIN_API_KEY.startsWith('HIER') || JSONBIN_BIN_ID.startsWith('HIER')) {
    return; // nicht konfiguriert
  }
  try {
    await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': JSONBIN_API_KEY
      },
      body: JSON.stringify(data)
    });
  } catch(e) {
    console.warn('Cloud-Speichern fehlgeschlagen:', e.message);
    showToast('âš ï¸ Cloud-Sync fehlgeschlagen â€“ lokal gespeichert');
  }
}

// â”€â”€ Speichern: lokal + cloud â”€â”€
function saveDB(data) {
  saveLocalDB(data);
  saveToCloud(data); // async, lÃ¤uft im Hintergrund
}

// â”€â”€ Init: versuche zuerst Cloud, dann lokalen Cache â”€â”€
async function initDB() {
  // Lokale Daten laden â€“ falls nichts vorhanden, Standarddaten verwenden
  let local = loadLocalDB();
  if (!local || !local.products || local.products.length === 0) {
    // Frische IDs generieren fÃ¼r Standardprodukte
    local = { products: getDefaultProducts() };
    saveLocalDB(local); // schlÃ¤gt im Inkognito fehl â€“ macht nichts
  }
  db = local;
  renderAll();
  updateSyncStatus('');
  return db;
}

function updateSyncStatus(msg) {
  const el = document.getElementById('syncStatus');
  if (el) el.textContent = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let db = { products: [] }; // wird durch initDB() befÃ¼llt
let expandedId = null;
let kurs = parseFloat(localStorage.getItem('wechselkurs') || '0.9400');
let pendingDeleteId = null;
let activeImageId = null; // for which product we're picking image

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WECHSELKURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('kursInput').value = kurs.toFixed(4);
document.getElementById('kursInput').addEventListener('change', () => {
  kurs = parseFloat(document.getElementById('kursInput').value) || 0.94;
  localStorage.setItem('wechselkurs', kurs);
  renderAll();
});

async function fetchKurs() {
  const btn = document.querySelector('.kurs-fetch-btn');
  btn.textContent = 'â³ LÃ¤dt...';
  btn.disabled = true;
  try {
    // Using open exchange-rate API (no key needed for EUR/CHF)
    const res = await fetch('https://api.exchangerate-api.com/v4/latest/CHF');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    const eurRate = data.rates && data.rates.EUR;
    if (eurRate) {
      kurs = parseFloat(eurRate.toFixed(4));
      document.getElementById('kursInput').value = kurs.toFixed(4);
      localStorage.setItem('wechselkurs', kurs);
      const date = new Date().toLocaleDateString('de-CH');
      document.getElementById('kursInfo').textContent = `Aktualisiert: ${date}`;
      showToast('âœ“ Kurs aktualisiert: 1 CHF = ' + kurs.toFixed(4) + ' EUR');
      renderAll();
    }
  } catch(e) {
    // Fallback: try another free API
    try {
      const res2 = await fetch('https://open.er-api.com/v6/latest/CHF');
      const data2 = await res2.json();
      if (data2.rates && data2.rates.EUR) {
        kurs = parseFloat(data2.rates.EUR.toFixed(4));
        document.getElementById('kursInput').value = kurs.toFixed(4);
        localStorage.setItem('wechselkurs', kurs);
        document.getElementById('kursInfo').textContent = `Aktualisiert: ${new Date().toLocaleDateString('de-CH')}`;
        showToast('âœ“ Kurs aktualisiert: 1 CHF = ' + kurs.toFixed(4) + ' EUR');
        renderAll();
      }
    } catch(e2) {
      showToast('âš ï¸ Kurs konnte nicht geladen werden. Bitte manuell eingeben.');
    }
  }
  btn.textContent = 'â†» Aktueller Kurs';
  btn.disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatCHF(val) {
  return val.toLocaleString('de-CH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function getNoPhoto() {
  // Returns the src for no-photo image
  const img = document.getElementById('flagCH_src'); // placeholder, we handle separately
  return 'keinfoto.jpg';
}

function renderAll() {
  const list = document.getElementById('productList');
  const empty = document.getElementById('emptyState');
  const count = document.getElementById('productCount');

  count.textContent = db.products.length + ' Produkte';

  if (db.products.length === 0) {
    list.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  list.innerHTML = '';
  db.products.forEach(p => {
    list.appendChild(renderCard(p));
  });
}

function renderCard(p) {
  const isExpanded = expandedId === p.id;
  const chfInEur = p.chf * kurs;
  const diff = Math.abs(chfInEur - p.eur);
  const chCheaper = chfInEur < p.eur;

  const card = document.createElement('div');
  card.className = 'product-card' + (isExpanded ? ' expanded' : '');
  card.dataset.id = p.id;

  // Image src
  const imgSrc = p.img || 'keinfoto.jpg';

  // Flag img tags
  const chFlagSrc = document.getElementById('flagCH_src') ? document.getElementById('flagCH_src').src : 'ch.jpg';
  const deFlagSrc = document.getElementById('flagDE_src') ? document.getElementById('flagDE_src').src : 'de.jpg';

  card.innerHTML = `
    <div class="product-row" onclick="toggleCard('${p.id}')">
      <div class="product-name">${escHtml(p.name)}</div>
      <div class="price-badges">
        <span class="badge badge-chf">${formatCHF(p.chf)} CHF</span>
        <span class="badge badge-eur">${formatCHF(p.eur)} EUR</span>
      </div>
      <span class="chevron">â–¼</span>
    </div>
    <div class="product-detail">
      <div class="detail-grid">
        <div class="detail-left">
          <div class="field-group">
            <label>Produktname</label>
            <input type="text" id="name_${p.id}" value="${escHtml(p.name)}">
          </div>
          <div class="field-group">
            <label>Preis CHF (Schweiz ğŸ‡¨ğŸ‡­)</label>
            <input type="number" id="chf_${p.id}" value="${p.chf}" step="0.01" oninput="onPriceChange('${p.id}')">
          </div>
          <div class="field-group">
            <label>Preis EUR (Deutschland ğŸ‡©ğŸ‡ª)</label>
            <input type="number" id="eur_${p.id}" value="${p.eur}" step="0.01" oninput="onPriceChange('${p.id}')">
          </div>
          <div class="converted-row">
            <span class="converted-label">CHF-Preis in EUR:</span>
            <span class="converted-value" id="conv_${p.id}">${formatCHF(chfInEur)} EUR</span>
          </div>
          <div class="fazit-box">
            <span class="fazit-text" id="fazit_${p.id}">
              <strong>${formatCHF(diff)} EUR</strong> gÃ¼nstiger in
            </span>
            <div class="fazit-flags">
              <img class="flag-img ${chCheaper ? '' : 'dim'}" id="flagCH_${p.id}" src="${chFlagSrc}" alt="CH" title="Schweiz">
              <img class="flag-img ${chCheaper ? 'dim' : ''}" id="flagDE_${p.id}" src="${deFlagSrc}" alt="DE" title="Deutschland">
            </div>
          </div>
        </div>
        <div class="detail-right">
          <div class="product-image-wrap" onclick="openLightbox('${p.id}')">
            <img id="img_${p.id}" src="${imgSrc}" alt="Produktbild"
              onerror="this.src='keinfoto.jpg'">
            <div class="img-overlay">ğŸ”</div>
          </div>
          <div class="img-buttons">
            <button class="btn-img" onclick="event.stopPropagation(); pickImage('${p.id}', false)" title="Aus Galerie">ğŸ–¼ Galerie</button>
            <button class="btn-img" onclick="event.stopPropagation(); pickImage('${p.id}', true)" title="Kamera">ğŸ“· Kamera</button>
            <button class="btn-img btn-img-del" onclick="event.stopPropagation(); deleteImage('${p.id}')" title="Bild lÃ¶schen">âœ•</button>
          </div>
        </div>
      </div>
      <div class="action-row">
        <button class="btn-save" onclick="saveProduct('${p.id}')">âœ“ Speichern</button>
        <button class="btn-delete" onclick="askDelete('${p.id}', '${escHtml(p.name)}')">ğŸ—‘ LÃ¶schen</button>
      </div>
    </div>
  `;

  return card;
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARD TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleCard(id) {
  expandedId = (expandedId === id) ? null : id;
  renderAll();
  if (expandedId) {
    setTimeout(() => {
      const card = document.querySelector(`[data-id="${expandedId}"]`);
      if (card) card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 50);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE PRICE CALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onPriceChange(id) {
  const chfVal = parseFloat(document.getElementById('chf_' + id).value) || 0;
  const eurVal = parseFloat(document.getElementById('eur_' + id).value) || 0;
  const chfInEur = chfVal * kurs;
  const diff = Math.abs(chfInEur - eurVal);
  const chCheaper = chfInEur < eurVal;

  const convEl = document.getElementById('conv_' + id);
  const fazitEl = document.getElementById('fazit_' + id);
  const flagCHEl = document.getElementById('flagCH_' + id);
  const flagDEEl = document.getElementById('flagDE_' + id);

  if (convEl) convEl.textContent = formatCHF(chfInEur) + ' EUR';
  if (fazitEl) fazitEl.innerHTML = `<strong>${formatCHF(diff)} EUR</strong> gÃ¼nstiger in`;
  if (flagCHEl) flagCHEl.className = 'flag-img' + (chCheaper ? '' : ' dim');
  if (flagDEEl) flagDEEl.className = 'flag-img' + (chCheaper ? ' dim' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE / DELETE / ADD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveProduct(id) {
  const nameEl = document.getElementById('name_' + id);
  const chfEl  = document.getElementById('chf_' + id);
  const eurEl  = document.getElementById('eur_' + id);

  const newName = nameEl ? nameEl.value.trim() : '';
  const newCHF  = parseFloat(chfEl ? chfEl.value : 0) || 0;
  const newEUR  = parseFloat(eurEl ? eurEl.value : 0) || 0;

  if (!newName) { showToast('âš ï¸ Name darf nicht leer sein!'); return; }

  const idx = db.products.findIndex(p => p.id === id);
  if (idx === -1) return;
  db.products[idx].name = newName;
  db.products[idx].chf  = newCHF;
  db.products[idx].eur  = newEUR;
  saveDB(db);
  expandedId = null;
  renderAll();
  showToast('âœ“ Gespeichert');
}

function askDelete(id, name) {
  pendingDeleteId = id;
  document.getElementById('confirmText').textContent = `MÃ¶chtest du "${name}" wirklich lÃ¶schen?`;
  document.getElementById('confirmOverlay').classList.add('active');
}
function closeConfirm() {
  pendingDeleteId = null;
  document.getElementById('confirmOverlay').classList.remove('active');
}
function confirmDelete() {
  if (!pendingDeleteId) return;
  db.products = db.products.filter(p => p.id !== pendingDeleteId);
  saveDB(db);
  if (expandedId === pendingDeleteId) expandedId = null;
  pendingDeleteId = null;
  closeConfirm();
  renderAll();
  showToast('ğŸ—‘ Produkt gelÃ¶scht');
}

// â”€â”€ ADD DIALOG â”€â”€
function openAddDialog() {
  document.getElementById('addName').value = '';
  document.getElementById('addCHF').value = '';
  document.getElementById('addEUR').value = '';
  document.getElementById('addOverlay').classList.add('active');
  setTimeout(() => document.getElementById('addName').focus(), 100);
}
function closeAddDialog() {
  document.getElementById('addOverlay').classList.remove('active');
}
function addProduct() {
  const name = document.getElementById('addName').value.trim();
  const chf  = parseFloat(document.getElementById('addCHF').value) || 0;
  const eur  = parseFloat(document.getElementById('addEUR').value) || 0;
  if (!name || !chf || !eur) {
    showToast('âš ï¸ Alle Felder ausfÃ¼llen!'); return;
  }
  const prod = { id: uid(), name, chf, eur, img: null };
  db.products.push(prod);
  saveDB(db);
  closeAddDialog();
  expandedId = prod.id;
  renderAll();
  showToast('âœ“ Produkt hinzugefÃ¼gt');
}

// â”€â”€ ENTER key in add dialog â”€â”€
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeAddDialog();
    closeConfirm();
    closeLightbox();
  }
  if (e.key === 'Enter' && document.getElementById('addOverlay').classList.contains('active')) {
    addProduct();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pickImage(id, useCamera) {
  activeImageId = id;
  const input = useCamera
    ? document.getElementById('cameraInput')
    : document.getElementById('fileInput');
  input.value = '';
  input.click();
}

function handleFileSelect(event) {
  const file = event.target.files[0];
  if (!file || !activeImageId) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const fullData = e.target.result; // data:image/...;base64,...
    // Resize before storing to save space
    resizeImage(fullData, 600, 400, (resized) => {
      const idx = db.products.findIndex(p => p.id === activeImageId);
      if (idx === -1) return;
      db.products[idx].img = resized;
      saveDB(db);
      // Update image without full re-render
      const imgEl = document.getElementById('img_' + activeImageId);
      if (imgEl) imgEl.src = resized;
      showToast('âœ“ Bild gespeichert');
    });
  };
  reader.readAsDataURL(file);
}

function resizeImage(dataUrl, maxW, maxH, callback) {
  const img = new Image();
  img.onload = function() {
    let w = img.width, h = img.height;
    if (w > maxW || h > maxH) {
      const ratio = Math.min(maxW / w, maxH / h);
      w = Math.round(w * ratio);
      h = Math.round(h * ratio);
    }
    const canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);
    callback(canvas.toDataURL('image/jpeg', 0.7));
  };
  img.src = dataUrl;
}

function deleteImage(id) {
  const idx = db.products.findIndex(p => p.id === id);
  if (idx === -1) return;
  db.products[idx].img = null;
  saveDB(db);
  const imgEl = document.getElementById('img_' + id);
  if (imgEl) { imgEl.src = 'keinfoto.jpg'; }
  showToast('âœ“ Bild entfernt');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(id) {
  const imgEl = document.getElementById('img_' + id);
  if (!imgEl) return;
  const src = imgEl.src;
  if (!src || src.endsWith('keinfoto.jpg')) return; // don't lightbox the dummy
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('active');
}
function closeLightbox() {
  document.getElementById('lightbox').classList.remove('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const kursVal = parseFloat(document.getElementById('kursInput').value) || kurs;
  const date = new Date().toLocaleDateString('de-CH');
  const pageW = doc.internal.pageSize.getWidth();

  // â”€â”€ Header Hintergrund â”€â”€
  doc.setFillColor(15, 15, 15);
  doc.rect(0, 0, pageW, 28, 'F');

  // â”€â”€ Titel â”€â”€
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(20);
  doc.setTextColor(232, 197, 71); // accent gelb
  doc.text('Preisvergleich CH / DE', 14, 12);

  doc.setFontSize(9);
  doc.setTextColor(180, 180, 180);
  doc.text('Erstellt am: ' + date + '   |   Wechselkurs: 1 CHF = ' + kursVal.toFixed(4) + ' EUR', 14, 20);

  // â”€â”€ Flaggen-Legende â”€â”€
  doc.setFontSize(8);
  doc.setTextColor(140, 140, 140);
  doc.text('Flagge zeigt: wo das Produkt guenstiger ist', pageW - 14, 20, { align: 'right' });

  // â”€â”€ Tabellen-Daten aufbereiten â”€â”€
  const rows = db.products.map((p, i) => {
    const chfInEur = p.chf * kursVal;
    const diff = Math.abs(chfInEur - p.eur);
    const chCheaper = chfInEur < p.eur;
    const diffFormatted = diff.toFixed(2).replace('.', '.');
    const winner = chCheaper ? 'CH guenstiger' : 'DE guenstiger';
    const saving = diffFormatted + ' EUR';

    return [
      i + 1,
      p.name,
      p.chf.toFixed(2) + ' CHF',
      p.eur.toFixed(2) + ' EUR',
      chfInEur.toFixed(2) + ' EUR',
      saving,
      winner
    ];
  });

  // â”€â”€ AutoTable â”€â”€
  doc.autoTable({
    startY: 32,
    head: [[
      '#',
      'Produkt',
      'Preis CH\n(CHF)',
      'Preis DE\n(EUR)',
      'CH-Preis\nin EUR',
      'Differenz\n(EUR)',
      'Guenstiger'
    ]],
    body: rows,
    theme: 'grid',
    styles: {
      font: 'helvetica',
      fontSize: 8.5,
      cellPadding: { top: 3, right: 4, bottom: 3, left: 4 },
      textColor: [30, 30, 30],
      lineColor: [200, 200, 200],
      lineWidth: 0.2,
      overflow: 'linebreak',
    },
    headStyles: {
      fillColor: [35, 35, 35],
      textColor: [232, 197, 71],
      fontStyle: 'bold',
      fontSize: 8,
      halign: 'center',
    },
    columnStyles: {
      0: { halign: 'center', cellWidth: 8 },
      1: { cellWidth: 55 },
      2: { halign: 'right', cellWidth: 22 },
      3: { halign: 'right', cellWidth: 22 },
      4: { halign: 'right', cellWidth: 22 },
      5: { halign: 'right', cellWidth: 22, fontStyle: 'bold' },
      6: { halign: 'center', cellWidth: 28 },
    },
    alternateRowStyles: {
      fillColor: [248, 248, 248],
    },
    didParseCell: function(data) {
      // Farbe fÃ¼r "Guenstiger"-Spalte
      if (data.column.index === 6 && data.section === 'body') {
        if (data.cell.raw.includes('CH')) {
          data.cell.styles.textColor = [180, 30, 40];   // CH rot
          data.cell.styles.fontStyle = 'bold';
        } else {
          data.cell.styles.textColor = [20, 100, 180];  // DE blau
          data.cell.styles.fontStyle = 'bold';
        }
      }
      // Differenz-Spalte grÃ¼n einfÃ¤rben
      if (data.column.index === 5 && data.section === 'body') {
        data.cell.styles.textColor = [40, 150, 80];
        data.cell.styles.fontStyle = 'bold';
      }
    },
    margin: { left: 14, right: 14 },
  });

  // â”€â”€ Zusammenfassung â”€â”€
  const finalY = doc.lastAutoTable.finalY + 8;
  const total = db.products.length;
  const chWins = db.products.filter(p => (p.chf * kursVal) < p.eur).length;
  const deWins = total - chWins;
  const avgSaving = db.products.reduce((sum, p) => {
    return sum + Math.abs((p.chf * kursVal) - p.eur);
  }, 0) / (total || 1);

  doc.setFillColor(245, 245, 245);
  doc.roundedRect(14, finalY, pageW - 28, 22, 3, 3, 'F');
  doc.setDrawColor(200, 200, 200);
  doc.roundedRect(14, finalY, pageW - 28, 22, 3, 3, 'S');

  doc.setFont('helvetica', 'bold');
  doc.setFontSize(8.5);
  doc.setTextColor(50, 50, 50);
  doc.text('Zusammenfassung:', 20, finalY + 7);

  doc.setFont('helvetica', 'normal');
  doc.setFontSize(8);
  doc.setTextColor(180, 30, 40);
  doc.text('CH guenstiger: ' + chWins + ' Produkte', 20, finalY + 14);
  doc.setTextColor(20, 100, 180);
  doc.text('DE guenstiger: ' + deWins + ' Produkte', 70, finalY + 14);
  doc.setTextColor(40, 150, 80);
  doc.text('Ã˜ Ersparnis: ' + avgSaving.toFixed(2) + ' EUR pro Produkt', 120, finalY + 14);

  // â”€â”€ Footer â”€â”€
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);
    doc.setFontSize(7.5);
    doc.setTextColor(160, 160, 160);
    doc.text('Preisvergleich CH/DE  â€“  Seite ' + i + ' von ' + pageCount, pageW / 2, 290, { align: 'center' });
  }

  // â”€â”€ Speichern â”€â”€
  const filename = 'Preisvergleich_' + date.replace(/\./g, '-') + '.pdf';
  doc.save(filename);
  showToast('âœ“ PDF erstellt: ' + filename);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MANUAL SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function manualSync() {
  if (JSONBIN_API_KEY.startsWith('HIER') || JSONBIN_BIN_ID.startsWith('HIER')) {
    showToast('âš ï¸ Bitte erst API-Key und Bin-ID eintragen!');
    return;
  }
  updateSyncStatus('â³ Synchronisiere...');
  const cloud = await loadFromCloud();
  if (cloud && cloud.products) {
    if (cloud.products.length >= db.products.length) {
      db = cloud;
      saveLocalDB(db);
      renderAll();
      showToast('â˜ï¸ Cloud-Daten geladen (' + db.products.length + ' Produkte)');
    } else {
      // Lokale Daten sind neuer â€“ hochladen
      await saveToCloud(db);
      showToast('â˜ï¸ Lokale Daten in Cloud gespeichert');
    }
    updateSyncStatus('â˜ï¸ Synchronisiert');
  } else {
    showToast('âš ï¸ Sync fehlgeschlagen');
    updateSyncStatus('âš ï¸ Sync-Fehler');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportData() {
  const json = JSON.stringify(db, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = 'preisvergleich_' + date + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('âœ“ Daten exportiert');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const parsed = JSON.parse(e.target.result);
      if (!parsed.products || !Array.isArray(parsed.products)) {
        showToast('âš ï¸ UngÃ¼ltige Datei â€“ kein gÃ¼ltiges Format');
        return;
      }
      // Ask confirmation if there are already products
      if (db.products.length > 0) {
        if (!confirm('Achtung: Alle aktuellen Daten werden mit den importierten Daten Ã¼berschrieben. Fortfahren?')) {
          event.target.value = '';
          return;
        }
      }
      db = parsed;
      saveDB(db);
      expandedId = null;
      renderAll();
      showToast('âœ“ ' + db.products.length + ' Produkte importiert');
    } catch(err) {
      showToast('âš ï¸ Fehler beim Lesen der Datei');
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initDB(); // async â€“ lÃ¤dt Cloud-Daten und rendert
</script>
</body>
</html>
